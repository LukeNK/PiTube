<!DOCTYPE html>
<html>
<head>
    <title>PiTube</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main>
        <div id="player">
            <video id="playerVid" controls></video>
            <audio id="playerAud" controls></audio>
        </div>
        <div id="controls">
            <button onclick="changeMode('a')">Audio</button>
            <button onclick="changeMode('m')">Mix</button>
            <button onclick="toggleLoop()">Loop</button>
            <!-- <button onclick="document.id('playerVid').currentTime += 5">-5s</button>
            <button onclick="document.id('playerVid').currentTime += 5">+5s</button> -->
        </div>
        <div id="browse"></div>
    </main>
</body>
<script>
    document.id = document.getElementById;

    // check url expiration date
    function expireCheck(url) {
        url = new URL(url)
        if (url.searchParams.get('expire') > new Date() / 1000)
            return true
        return false
    }

    // mode
    let playerMode = 'm'
    function changeMode(mode) {
        playerMode = mode;
        document.id('playerAud').pause();
        document.id('playerVid').pause();
        if (mode == 'a') {
            // audio only
            document.id('playerAud').style.display = 'block';
            document.id('playerVid').style.display = 'none';
        } else if (mode == 'm') {
            // mix video mode
            document.id('playerAud').style.display = 'none';
            document.id('playerVid').style.display = 'block';
        }
    }
    changeMode('m'); // init

    // loop
    function toggleLoop() {
        document.id('playerVid').loop = !document.id('playerVid').loop;
        document.id('playerAud').loop = !document.id('playerAud').loop;
    }

    // fetch database
    fetch('/database').then(res => res.json())
    .then(res => {
        let browse = document.id('browse');
        for (const id of Object.keys(res)) {
            // client check links to reduce server load
            if (!expireCheck(res[id].url))
                return fetch('/expire#' + id);

            let div = document.createElement('div'),
                h = document.createElement('h3');

            div.innerHTML = `<img src="${res[id].thumbnail_url}">`;
            div.addEventListener('click', ev => {
                document.id('player').style.display = 'block';
                if (playerMode == 'a')
                    document.id('playerAud').src = res[id].aUrl
                else
                    document.id('playerVid').src = res[id].url
            })

            h.innerText = res[id].title

            div.append(h);
            if (id == location.hash.slice(1))
                div.click()

            browse.prepend(div);
        }
    });
</script>
</html>